pipeline {
    agent any
    environment {
        BASE_URL = "https://cxeecy1pki.execute-api.us-east-1.amazonaws.com/Prod"
    }
    stages {
        stage('Get Code') {
            agent { label 'default' }
            steps {
                git branch: 'develop', url:'https://github.com/caracarton/Caso1.4'
                stash name: 'source', includes: '**/*'
            }
        }
        
      stage('Static Test') {
    agent { label 'estatico' }
    steps {
        unstash 'source'
        sh '''
            whoami
            hostname
            flake8 --exit-zero --format=pylint ./src --output-file=flake8.out
            bandit -r ./src -f json -o bandit.json
           '''
    }
    post {
        always {
           recordIssues tools: [
            flake8(pattern: 'flake8.out'),
            sarif(pattern: 'bandit.json')
]
        }
    }
}
      stage('Deploy') {
          agent { label 'default' }
            steps {
             sh '''
                sam build
                sam validate --region us-east-1
                sam deploy \
                --stack-name staging1 \
                --region us-east-1 \
                --capabilities CAPABILITY_IAM \
                --no-confirm-changeset \
                --no-fail-on-empty-changeset
                '''
    }
}
      stage('Rest Test') {
          agent { label 'apirest' }
            steps{
                unstash 'source'
                sh '''
                whoami
                hostname
                pytest test/integration/todoApiTest.py --exitfirst
                '''
          }
      }
      stage('Promote') {
          agent { label 'default' }
              steps {
        withCredentials([usernamePassword(
            credentialsId: 'credenciales',
            usernameVariable: 'GIT_USER',
            passwordVariable: 'GIT_PASS'
        )]) {
            sh '''
                git config user.name "jenkins"
                git config user.email "jenkins@ci.local"
                git remote set-url origin https://$GIT_USER:$GIT_PASS@github.com/caracarton/Caso1.4.git
                git fetch origin master
                git checkout -B master origin/master
                git merge origin/develop --no-edit
                git push origin master
            '''
        }
    }
}
      }
}